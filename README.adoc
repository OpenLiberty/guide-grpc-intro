// Copyright (c) 2022 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
// https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//
:projectid: grpc-intro
:page-layout: guide-multipane
:page-duration: 30 minutes
:page-releasedate: 2022-09-08
:page-description: Learn how to use gRPC unary, server streaming, client streaming, and bidirectional streaming to communicate client and server services in Open Liberty.
:page-tags: ['gRPC']
:page-permalink: /guides/{projectid}
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:imagesdir: /img/guide/{projectid}
:source-highlighter: prettify
:page-seo-title: Communicating client and server services with gRPC streaming calls
:page-seo-description: A getting started tutorial with examples on how to run unary, server streaming, client streaming, and bidirectional streaming by using gRPC Remote Procedure Calls in Open Liberty.
:guide-author: Open Liberty
= Communicating client and server services with gRPC streaming calls

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Learn how to use gRPC unary, server streaming, client streaming, and bidirectional streaming to communicate client and server services in Open Liberty.

// ===============================================================================================
//  What you'll learn
// ===============================================================================================

== What is gRPC?

https://grpc.io/[gRPC^] Remote Procedure Call is a technology that implements remote procedure call (RPC) style APIs with HTTP/2. gRPC uses Protocol Buffers to define its routines that include service calls and expected messages. For each service defined in a `.proto` file, gRPC uses it to generate the skeleton code for users to implement and extend. Protocol buffers use a binary format to send and receive messages that are much faster and lightweight compared to JSON used in RESTful APIs.

Protocol buffers allow cross project support through the `.proto` file, as a result gRPC clients and servers are also able to run and communicate with each other on different environments. For example, a gRPC client running in Java codebase is able to call a gRPC server from a Python codebase. This feature of protocol buffers allows for easier integration between services.

== What you'll learn

You will learn how to create gRPC client and server services by using protocol buffers and how to implement them with Open Liberty. You will use Maven throughout the guide to generate the gRPC stubs and deploy the services and to interact with the running Liberty server.

The application that you will build in this guide consists of the `systemproto` model project, the `query` client service, and the `system` server service. The `query` service implements four RESTful APIs by using four different gRPC streaming methods.

image::architecture.png[gRPC application architecture where the system service provides gRPC server and the query service to make different gRPC streaming calls. align="center"]

// ===============================================================================================
// Getting Started
// ===============================================================================================
[role='command']
include::{common-includes}/gitclone.adoc[]

=== Try what you'll build

The `finish` directory in the root of this guide contains the finished application. Give it a try before you proceed.

To try out the application, first go to the `finish` directory and run the following Maven goal to generate all the gRPC abstract classes defined in the `.proto` file. 

// generate gRPC classes
[role='command']
----
cd finish
mvn -pl systemproto install
----

Start the `system` service by running the following command:
// starting system
[role='command']
----
mvn -pl system liberty:run
----

Next, open another command-line session and start the `query` service by using the following command:
// starting query
[role='command']
----
mvn -pl query liberty:run
----

Point your browser to the http://localhost:9081/query/properties/os.name URL to test out the basic unary service. You will see your operating system name. Next, point your browser to the following URLs to try out:

* server streaming - http://localhost:9081/query/properties/os 

* client streaming - http://localhost:9081/query/properties/user

* bidirectional streaming - http://localhost:9081/query/properties/java

Observe the output from the consoles running the `system` and `query` services.

After you are finished checking out the application, stop both the `query` and `system` services by pressing `CTRL+C` in the command-line sessions where you ran them. Alternatively, you can run the following goals from the `finish` directory in another command-line session:
// stopping dev mode
[role='command']
----
mvn -pl system liberty:stop
mvn -pl query liberty:stop
----

// ===============================================================================================
// Creating proto file and generating gRPC stubs
// ===============================================================================================

== Creating and defining gRPC service

Navigate to the `start` directory to begin.

First, create the `.proto` file and generate gRPC classes. You will implement the gRPC server with the generated classes later. The `.proto` file defines all the service calls and message types. The message types are used in the service call definition for the parameters and returns.

// Create SystemProto.proto
[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `SystemService.proto` file.#
`systemproto/src/main/proto/SystemService.proto`
----
SystemService.proto
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright"]
----
include::finish/systemproto/src/main/proto/SystemService.proto[]
----

// Import pom.xml
pom.xml
[source, XML, linenums, role="code_column"]
----
include::finish/systemproto/pom.xml[]
----

The first few lines define the [hotspot=basicConfig file=0]`syntax`, [hotspot=basicConfig file=0]`package`, and [hotspot=basicConfig file=0]`option` basic configuration of the `.proto` file. The [hotspot=SystemService file=0]`SystemService` service contains the four service calls that will be implemented in the coming sections.

The [hotspot=getProperty file=0]`getProperty` rpc defines the unary call. In this call, the client side sends a `SystemPropertyName` message to the server side that returns back a `SystemPropertyValue` message with the property value. The [hotspot=SystemPropertyName file=0]`SystemPropertyName` and [hotspot=SystemPropertyValue file=0]`SystemPropertyValue` message types define that the `propertyName` and `propertyValue` must be string.

The [hotspot=getPropertiesServer file=0]`getPropertiesServer` rpc defines the server streaming call. The client side sends a `SystemPropertyName` message to the server side. The server returns back a stream of `SystemProperty` messages. Each [hotspot=SystemProperty file=0]`SystemProperty` message contains a `propertyName` and a `propertyValue` strings.

The [hotspot=getPropertiesClient file=0]`getPropertiesClient` rpc defines the client streaming call. The client side streams `SystemPropertyName` messages to the server side. The server returns back a [hotspot=SystemProperties file=0]`SystemProperties` message that contains a map of the properties with their respective values.


The [hotspot=getPropertiesBidirect file=0]`getPropertiesBidirect` rpc defines the bidirectional streaming call. In this service, the client side streams `SystemPropertyName` messages to the server side. The server returns back a stream of [hotspot=SystemProperty file=0]`SystemProperty` messages.

To compile the `.proto` file, the `pom.xml` Maven configuration file needs the  [hotspot=grpc file=1]`grpc-protobuf` and [hotspot=grpc-stub file=1]`grpc-stub` dependencies, and the [hotspot=protobufmavenplugin file=1]`protobuf-maven-plugin` plugin. To install the correct version of Protobuf compiler automatically, the [hotspot=osmavenplugin file=1]`os-maven-plugin` extension is required in the `build` configuration.

Run the following command to generate the gRPC classes.
// run mvn install to generate abstract classes
[role='command']
----
mvn -pl systeproto install
----

// ===============================================================================================
// Implementing unary call
// ===============================================================================================

== Implementing unary call

Navigate to the `start` directory.

When you run Open Liberty in development mode, known as dev mode, the server listens for file changes and automatically recompiles and deploys your updates whenever you save a new change. Run the following command to start the `system` service in dev mode:

// start dev mode for system
[role='command']
```
mvn -pl system liberty:dev
```

Open another command-line session and run the following commands to start the `query` service in dev mode:

// start dev mode for query
[role='command']
```
mvn -pl query liberty:dev
```

After you see the following message, your application servers in dev mode are ready:

[role="no_copy"]
----
**************************************************************
*    Liberty is running in dev mode.
----

Dev mode holds your command-line session to listen for file changes. Open another command-line session to continue, or open the project in your editor.

Start by implementing the first service call, the unary call. In this service call, the `query` client service sends a property to the `system` server service that will return the property value. This type of service call resembles the RESTful API. 

// Create SystemService
[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `SystemService` class.#
`system/src/main/java/io/openliberty/guides/system/SystemService.java`
----

SystemService.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,getPropertiesServer,getPropertiesClient,getPropertiesBidirect"]
----
include::finish/system/src/main/java/io/openliberty/guides/system/SystemService.java[]
----

The `SystemService` class implements the `SystemServiceGrpc` class that is generated by the proto file. The four types of services defined in the proto file are implemented in this class.

The [hotspot=getProperty file=0]`getProperty()` method implements the rpc unary call defined in the proto file. Use the [hotspot=pName file=0]`getPropertyName()` getter method that is generated by gRPC to retrieve the property name from the client, and store into the `pName` variable. Get and store the System property value into the [hotspot=pValue file=0]`pValue` variable. Use the the gRPC APIs to create a [hotspot=response file=0]`SystemPropertyValue` message that its type is defined in the `SystemService.proto` file. Then, send the message to the client service through the `StreamObserver` by using its [hotspot=next file=0]`onNext()` and [hotspot=complete file=0]`onComplete()` methods.

// update server.xml
[role='code_command hotspot file=1', subs="quotes"]
----
#Replace the `system` server configuration file.#
`system/src/main/liberty/config/server.xml`
----

system/server.xml
[source, xml, linenums, role='code_column hide_tags=copyright']
----
include::finish/system/src/main/liberty/config/server.xml[]
----

Add the [hotspot=grpc file=1]`grpc` feature to the Liberty server configuration file. That feature enables gRPC server compatibility with the Liberty server. Configure the [hotspot=grpcConfig file=1]`grpc` feature with the `target` attribute. If you want to learn more about `grpc` feature configuration, see the https://openliberty.io/docs/latest/reference/config/grpc.html[GRPC Server Properties^].

Implement the RESTful endpoint in the `query` service.

// Create PropertiesResource
[role="code_command hotspot file=2", subs="quotes"]
----
#Create the `PropertiesResource` class.#
`query/src/main/java/io/openliberty/guides/query/PropertiesResource.java`
----

PropertiesResource.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,serverStreaming,clientStreaming,bidirectionalStreaming"]
----
include::finish/query/src/main/java/io/openliberty/guides/query/PropertiesResource.java[]
----
The `PropertiesResource` class provides RESTful endpoints to interact with the `system` service. The [hotspot=unary file=2]`/query/properties/${propertyName}` endpoint uses the unary service call to get the property value from the `system` service. The endpoint creates a [hotspot=createChannel1 file=2]`channel`, uses the channel to create a client by the [hotspot=createClient1 file=2]`SystemServiceGrpc.newBlockingStub()` API, uses the client to get the property value, shutdowns the channel, and then returns the value that the `system` service responses immediately.

// update server.xml
[role='code_command hotspot file=3', subs="quotes"]
----
#Replace the `query` server configuration file.#
`query/src/main/liberty/config/server.xml`
----

query/server.xml
[source, xml, linenums, role='code_column hide_tags=copyright']
----
include::finish/query/src/main/liberty/config/server.xml[]
----

Add the [hotspot=grpc file=3]`grpc` and [hotspot=grpcClient file=3]`grpcClient` features to the Liberty server configuration file. Both features enable gRPC server and client compatibility with the Liberty server. Configure the [hotspot=grpcClientConfig file=3]`grpcClient` feature with the `headersToPropagate` and `target` attributes. If you want to learn more about `grpcClient` feature configuration, see the https://openliberty.io/docs/latest/reference/config/grpcClient.html[GRPC Client Properties^].

Because you are running the `system` and `query` services in dev mode, the changes that you made were automatically picked up. You’re now ready to check out your application in your browser.

Point your browser to the http://localhost:9081/query/properties/os.name URL to test out the unary service. You should see your operating system name. You can try out the URL with other property name.


// ===============================================================================================
// Implementing server streaming call
// ===============================================================================================

== Implementing server streaming call

In the server streaming call, the `query` client service provides the `/query/properties/os` endpoint that sends a message to the `system` server service. The `system` service streams the properties started with `os.` back to the `query` service. A channel is created between the `query` and the `system` services to stream messages. The channel is only closed by the `system` service after sending the last message to the `query` service. 

// Commands for system service
Update the `SystemService` class to implement the server streaming rpc call.
// Replace SystemService
[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `SystemService` class.#
`system/src/main/java/io/openliberty/guides/system/SystemService.java`
----
SystemService.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,getPropertiesClient,getPropertiesBidirect"]
----
include::finish/system/src/main/java/io/openliberty/guides/system/SystemService.java[]
----

The [hotspot=getPropertiesServer file=0]`getPropertiesServer()` method implements server streaming rpc call. Use the [hotspot=prefix file=0]`getPropertyName()` getter method to retrieve the property prefix from the client. Filter out the properties that starts with the [hotspot=filter file=0]`prefix`. For each property, build a [hotspot=serverMessage file=0]`SystemProperty` message and stream the message to the client through the `StreamObserver` by using its [hotspot=serverNext1 file=0]`onNext()` method. When all properties are streamed, finish the streaming by calling the [hotspot=serverComplete file=0]`onComplete()` method.

Update the `PropertiesResource` class to implement the `/query/properties/os` endpoint of the `query` service.

// Replace PropertiesResource
[role="code_command hotspot file=1", subs="quotes"]
----
#Replace the `PropertiesResource` class.#
`query/src/main/java/io/openliberty/guides/query/PropertiesResource.java`
----

PropertiesResource.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,clientStreaming,bidirectionalStreaming"]
----
include::finish/query/src/main/java/io/openliberty/guides/query/PropertiesResource.java[]
----

The endpoint creates a [hotspot=createChannel2 file=1]`channel` to the `system` service and a [hotspot=createClient2 file=1]`client` by using the `SystemServiceGrpc.newStub()` API. Then, call the [hotspot=getPropertiesServer file=1]`getPropertiesServer()` method with an implementation of the `StreamObserver` interface. The [hotspot=onNext1 file=1]`onNext()` method receives messages streaming from the server individually and stores them into the `properties` placeholder. After all properties are received, shutdown the [hotspot=closeConnection file=1]`channel` and returns the placeholder. Because the rpc call is asynchronous, use a [hotspot=countDownLatch1 hotspot=countDownLatch2 hotspot=countDownLatch3 file=1]`CountDownLatch` to synchronize the streaming flow.

Point your browser to the http://localhost:9081/query/properties/os URL to test out the server streaming. You should see the `os.` properties from the `system` service. Observe the output from the consoles running the `system` and `query` services.


// ===============================================================================================
// Implementing client streaming call
// ===============================================================================================


== Implementing client streaming call

In the client streaming call, the `query` client service provides the `/query/properties/user` endpoint that streams the user properties to the `system` server service. The `system` service returns a map of user properties with their values.

Update the `SystemService` class to implement the client streaming rpc call.

// Replace SystemService
[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `SystemService` class.#
`system/src/main/java/io/openliberty/guides/system/SystemService.java`
----

SystemService.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,getPropertiesBidirect"]
----
include::finish/system/src/main/java/io/openliberty/guides/system/SystemService.java[]
----

The [hotspot=getPropertiesClient file=0]`getPropertiesClient()` method implements client streaming rpc call. This method returns an instance of the [hotspot=streamObserverClient file=0]`StreamObserver` interface. Its [hotspot=receivingProperties file=0]`onNext()` method receives the messages from the client individually and stores the property values into the [hotspot=clientStreamingMap file=0]`properties` map placeholder. When the streaming is completed, the `properties` placeholder is sent back to the client by the [hotspot=clientStreamingCompleted file=0]`onCompleted()` method.


// Replace PropertiesResource
Update the `PropertiesResource` class to implement of `/query/properties/user` endpoint of the query service.

[role="code_command hotspot file=1", subs="quotes"]
----
#Replace the `PropertiesResource` class.#
`/query/src/main/java/io/openliberty/guides/query/PropertiesResource.java`
----

PropertiesResource.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright,bidirectionalStreaming"]
----
include::finish/query/src/main/java/io/openliberty/guides/query/PropertiesResource.java[]
----

After a connection is created between the two services, call the [hotspot=getPropertiesClient file=1]`client.getPropertiesClient()` API to get a `stream`, collect the properties started with [hotspot=collectUserProperties file=1]`user.`, create a [hotspot=clientMessage1 file=1]`SystemPropertyName` message individually, and send the message to the server through by the [hotspot=streamOnNext1 file=1]`stream::onNext` action. When all property names are sent, finish the streaming by calling the [hotspot=clientCompleted1 file=1]`onCompleted()`. Again, use a [hotspot=countDownLatch4 hotspot=countDownLatch5 hotspot=countDownLatch6 file=1]`CountDownLatch` to synchronize the streaming flow.

Point your browser to the http://localhost:9081/query/properties/user URL to test out the client streaming. You should see the `user.` properties from the `system` service. Observe the output from the consoles running the `system` and `query` services.


// ===============================================================================================
// Implementing bidirectional streaming call
// ===============================================================================================

== Implementing bidirectional streaming call

In the bidirectional streaming call, the `query` client service provides the `/query/properties/java` endpoint that streams the property names started with `java.` to the `system` server service. The `system` service streams the property values back to the `query` service.

Update the `SystemService` class to implement the bidirectional streaming rpc call.

// Replace SystemService
[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `SystemService` class.#
`system/src/main/java/io/openliberty/guides/system/SystemService.java`
----

SystemService.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright"]
----
include::finish/system/src/main/java/io/openliberty/guides/system/SystemService.java[]
----

The [hotspot=getPropertiesBidirect file=0]`getPropertiesBidirect()` method implements bidirectional streaming rpc call. This method returns an instance of the [hotspot=streamObserverBidirectional file=0]`StreamObserver` interface. Its [hotspot=receiveBidirectionalProperties file=0]`onNext()` method receives the messages from the client individually, creates a [hotspot=systemPropertyMessage file=0]`SystemProperty` message with the property name and value, and sends the message back to the client by the [hotspot=serverNext2 file=0]`onNext()` method. When the client streaming is completed, close the server streaming by calling the [hotspot=bidirectionalCompleted file=0]`onCompleted()` method.


Update the `PropertiesResource` class to implement of `/query/properties/java` endpoint of the query service.

// Replace PropertiesResource
[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `PropertiesResource` class.#
`query/src/main/java/io/openliberty/guides/query/PropertiesResource.java`
----

PropertiesResource.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright"]
----
include::finish/query/src/main/java/io/openliberty/guides/query/PropertiesResource.java[]
----

After a connection is created between the two services, call the [hotspot=getPropertiesBidirect file=1]`client.getPropertiesBidirect()` API with an implementation of the `StreamObserver` interface. The [hotspot=onNext2 file=1]`onNext()` method receives messages streaming from the server individually and stores them into the `properties` placeholder. Then, collect the properties started with [hotspot=collectJavaProperties file=1]`java.`, create a [hotspot=clientMessage2 file=1]`SystemPropertyName` message individually, and send the message to the server through by the [hotspot=streamOnNext2 file=1]`stream::onNext` action. When all property names are sent, finish the streaming by calling the [hotspot=clientCompleted2 file=1]`onCompleted()`. Again, use a [hotspot=countDownLatch7 hotspot=countDownLatch8 hotspot=countDownLatch9 file=1]`CountDownLatch` to synchronize the streaming flow.


Point your browser to the http://localhost:9081/query/properties/java URL to test out the bidirectional streaming. You should see the `java.` properties from the `system` service. Observe the output from the consoles running the `system` and `query` services.

// ===============================================================================================
// Testing the application
// ===============================================================================================

== Testing the application
// Create QueryIT.java
[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `QueryIT` class.#
`finish/query/src/test/java/it/io/openliberty/guides/query/QueryIT.java`
----

QueryIT.java
[source, Java, linenums, indent=0, role="code_column hide_tags=copyright"]
----
include::finish/query/src/test/java/it/io/openliberty/guides/query/QueryIT.java[]
----
Each test case tests one of the methods for instantiating a RESTful client.

The [hotspot=getPropertiesString file=0]`testGetPropertiesString()` tests the `http://localhost:9081/query/properties/os.name` endpoint and confirms that a response is received. 

The [hotspot=getOSProperties file=0]`testGetOSProperties()` tests the `http://localhost:9081/query/properties/os` endpoint and confirms that a response is received. 

The [hotspot=getUserProperties file=0]`testGetUserProperties()` tests the `http://localhost:9081/query/properties/user` endpoint and confirms that a response is received. 

The [hotspot=getJavaProperties file=0]`testGetJavaProperties()` tests the `http://localhost:9081/query/properties/java` endpoint and confirms that a response is received. 

[role=command]
include::{common-includes}/devmode-test.adoc[]

[source, role="no_copy"]
----
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running it.io.openliberty.guides.query.QueryIT
[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.247 s - in it.io.openliberty.guides.query.QueryIT
[INFO] 
[INFO] Results:
[INFO] 
[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] Integration tests finished.
----

When you are finished, exit dev mode by pressing `CTRL+C` in the
command-line session that the container was started from, or by typing `q` and
then pressing the `enter/return` key.

// ===============================================================================================
// Great work! You're done!
// ===============================================================================================

== Great work! You're done!

You just developed an application that implements four unique calls with gRPC by using Open Liberty. 

include::{common-includes}/attribution.adoc[subs="attributes"]
